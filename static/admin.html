<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bokningar • Admin</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ---------- Background & Glass ---------- */
    :root{
      --bg1:#0b0b0c;       /* near-black */
      --glow1:#fb6a2c;     /* warm orange glow */
      --glow2:#7c3aed;     /* purple glow */
    }
    body{
      min-height:100vh;
      background: radial-gradient(1200px 600px at 15% 0%, rgba(251,106,44,0.18), transparent 60%),
                  radial-gradient(1000px 500px at 85% 12%, rgba(124,58,237,0.16), transparent 60%),
                  linear-gradient(180deg, #0b0b0c 0%, #0b0b0c 100%);
      color: #e5e7eb; /* slate-200 */
    }
    .glass{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.20);
      box-shadow:
        0 10px 30px rgba(0,0,0,.35),
        inset 0 1px 0 rgba(255,255,255,.10);
      backdrop-filter: blur(18px) saturate(160%);
      -webkit-backdrop-filter: blur(18px) saturate(160%);
      border-radius: 16px;
    }
    .subglass{
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(12px) saturate(140%);
      -webkit-backdrop-filter: blur(12px) saturate(140%);
      border-radius: 12px;
    }
    /* ---------- Small UI helpers ---------- */
    .chip{ padding: 2px 10px; border-radius: 9999px; font-size:12px; line-height: 18px; }
    .chip-pending{ background: rgba(234,179,8,.18); color:#facc15; border:1px solid rgba(250,204,21,.35);}
    .chip-confirmed{ background: rgba(16,185,129,.18); color:#34d399; border:1px solid rgba(52,211,153,.35);}
    .chip-cancelled{ background: rgba(244,63,94,.18); color:#fb7185; border:1px solid rgba(251,113,133,.35);}
    .btn{ height:36px; padding:0 14px; border-radius:12px; font-weight:600; font-size:14px; transition: all .15s ease; }
    .btn-ghost{ background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.18);}
    .btn-ghost:hover{ background: rgba(255,255,255,0.10);}
    .btn-primary{ background:#60a5fa; color:#0b0b0c; }  /* light blue */
    .btn-primary:hover{ background:#3b82f6; }
    .btn-dark{ background:#0b0b0c; border:1px solid rgba(255,255,255,0.18);}
    .btn-dark:hover{ background:#141416; }
    .input{
      height:40px; border-radius:12px; padding:0 14px; background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.18); color:#e5e7eb;
    }
    .input::placeholder{ color:rgba(229,231,235,.55); }
    .table thead th{ font-size:12px; font-weight:700; letter-spacing:.02em; color:#bfc3ca; padding:12px 12px; text-align:left; }
    .table tbody td{ padding:14px 12px; border-top:1px solid rgba(255,255,255,0.08); }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <div class="max-w-7xl mx-auto px-5 py-10">

    <!-- ======================= GATE (Portal key only) ======================= -->
    <div id="gate" class="glass p-8 max-w-xl mx-auto">
      <div class="text-2xl font-semibold tracking-tight mb-1">Admin-inloggning</div>
      <div class="text-sm text-slate-400 mb-6">Ange din portalnyckel för att fortsätta.</div>
      <form id="gateForm" class="grid gap-3">
        <div class="subglass p-2">
          <label for="gate_key" class="block text-xs text-slate-400 px-2 pt-1 pb-1">X-Portal-Key</label>
          <input id="gate_key" class="w-full input" placeholder="klistra in din portalnyckel" autocomplete="off" />
        </div>
        <div class="flex justify-end">
          <button class="btn btn-primary" type="submit">Fortsätt</button>
        </div>
      </form>
    </div>

    <!-- ======================= APP (Dashboard) ======================= -->
    <div id="app" class="hidden">
      <div class="glass p-6 md:p-8">
        <!-- Header -->
        <div class="flex items-center justify-between">
          <div>
            <div class="text-2xl font-semibold tracking-tight">Bookings</div>
            <div class="text-sm text-slate-400 mt-1">Admin panel</div>
          </div>
          <div class="flex gap-3">
            <button id="reloadBtn" class="btn btn-dark">Reload</button>
            <button id="newBtn" class="btn btn-primary">New booking</button>
          </div>
        </div>

        <!-- Controls (search only now) -->
        <div class="grid md:grid-cols-1 gap-3 mt-6">
          <div class="subglass p-2">
            <label class="block text-xs text-slate-400 px-2 pt-1 pb-1">Search</label>
            <input id="searchInput" class="w-full input" placeholder="name, email, phone, code" />
          </div>
        </div>

        <!-- Status tabs -->
        <div class="flex items-center gap-2 mt-4">
          <button data-status="" class="btn btn-ghost" id="tabAll">All</button>
          <button data-status="pending" class="btn btn-ghost" id="tabPending">Pending</button>
          <button data-status="confirmed" class="btn btn-ghost" id="tabConfirmed">Confirmed</button>
          <button data-status="cancelled" class="btn btn-ghost" id="tabCancelled">Cancelled</button>
        </div>

        <!-- Table -->
        <div class="subglass mt-6 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="table w-full">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Code</th>
                  <th>Namn</th>
                  <th>E-post</th>
                  <th>Telefon</th>
                  <th>Datum</th>
                  <th>Tid</th>
                  <th>Behandling</th>
                  <th>Status</th>
                  <th>Åtgärder</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
          <div id="empty" class="hidden p-10 text-center text-slate-400">
            Inga bokningar hittades.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- New booking modal -->
  <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="glass w-full max-w-lg mx-4 p-6 relative">
      <div class="text-lg font-semibold mb-4">Ny bokning</div>
      <div class="grid grid-cols-2 gap-3">
        <input id="m_name" class="input col-span-2" placeholder="Namn" />
        <input id="m_email" class="input col-span-2" placeholder="E-post (krävs)" />
        <input id="m_phone" class="input col-span-2" placeholder="Telefon (valfritt)" />
        <input id="m_date" class="input" type="date" />
        <input id="m_time" class="input" type="time" />
        <input id="m_treatment" class="input col-span-2" placeholder="Behandling" />
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button id="m_close" class="btn btn-ghost">Avbryt</button>
        <button id="m_save" class="btn btn-primary">Spara</button>
      </div>
    </div>
  </div>

  <script>
    // ------- tiny helper -------
    const $ = s => document.querySelector(s);

    const gateEl = $("#gate");
    const appEl  = $("#app");
    const rowsEl = $("#rows");
    const emptyEl = $("#empty");
    const searchInput = $("#searchInput");

    let statusFilter = "";
    let items = [];

    function showApp() {
      gateEl.classList.add("hidden");
      appEl.classList.remove("hidden");
      load();
    }

    function showGate() {
      appEl.classList.add("hidden");
      gateEl.classList.remove("hidden");
      const input = $("#gate_key");
      input.value = "";                    // never auto-fill anything weird
      input.focus();
    }

    // Gate submit
    $("#gateForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const key = ($("#gate_key").value || "").trim();
      if (!key) return;
      localStorage.setItem("portal_key", key);
      showApp();
    });

    // First render decision
    (function boot(){
      const key = (localStorage.getItem("portal_key") || "").trim();
      if (key) showApp(); else showGate();
    })();

    function chip(status){
      const s = (status || "pending").toLowerCase();
      const cls = s === "confirmed" ? "chip chip-confirmed"
                : s === "cancelled" ? "chip chip-cancelled"
                : "chip chip-pending";
      return `<span class="${cls}">${s}</span>`;
    }

    function pad4(n){ return String(n).padStart(4, "0"); }

    function render(){
      const q = (searchInput?.value || "").toLowerCase().trim();
      let list = items;
      if (q){
        list = list.filter(r =>
          (r.name || "").toLowerCase().includes(q) ||
          (r.email || "").toLowerCase().includes(q) ||
          (r.phone || "").toLowerCase().includes(q) ||
          (r.appointment_id || pad4(r.id)).toLowerCase().includes(q)
        );
      }
      rowsEl.innerHTML = list.map(r => {
        const code = r.appointment_id || pad4(r.id);
        const act = `
          <div class="flex gap-2">
            <button class="btn btn-ghost" onclick="resend(${r.id})">Resend</button>
            <button class="btn btn-ghost" onclick="setStatus(${r.id}, 'confirmed')">Confirm</button>
            <button class="btn btn-ghost" onclick="setStatus(${r.id}, 'cancelled')">Cancel</button>
          </div>`;
        return `<tr>
          <td class="text-slate-300">${r.id}</td>
          <td class="font-semibold kbd">${code}</td>
          <td>${r.name || ""}</td>
          <td>${r.email || ""}</td>
          <td>${r.phone || ""}</td>
          <td>${r.date || ""}</td>
          <td>${r.time || ""}</td>
          <td>${r.treatment || ""}</td>
          <td>${chip(r.status)}</td>
          <td>${act}</td>
        </tr>`;
      }).join("");

      emptyEl.classList.toggle("hidden", list.length > 0);
    }

    async function api(path, options={}){
      const key = (localStorage.getItem("portal_key") || "").trim();
      if (!key){ showGate(); throw new Error("missing key"); }

      const headers = Object.assign({
        "Content-Type":"application/json",
        "X-Portal-Key": key
      }, options.headers || {});

      const url = `${path}`; // no clinic param anymore
      const res = await fetch(url, {...options, headers});
      if (!res.ok){
        const text = await res.text();
        throw new Error(`HTTP ${res.status} — ${text}`);
      }
      const ct = res.headers.get("content-type") || "";
      return ct.includes("application/json") ? res.json() : res.text();
    }

    async function load(){
      try{
        const statusQ = statusFilter ? `&status=${encodeURIComponent(statusFilter)}` : "";
        const data = await api(`/portal/api/bookings?limit=200${statusQ}`);
        items = data.items || [];
        render();
      }catch(e){
        console.error(e);
        alert("Kunde inte hämta bokningar: " + e.message);
      }
    }

    async function resend(id){
      try{
        await api(`/portal/api/bookings/resend`, {
          method:"POST",
          body: JSON.stringify({ booking_id: id })
        });
        alert("Bekräftelse skickad.");
      }catch(e){
        alert("Kunde inte skicka bekräftelse: " + e.message);
      }
    }

    async function setStatus(id, status){
      try{
        await api(`/portal/api/bookings/${id}/status`, {
          method:"POST",
          body: JSON.stringify({ status })
        });
        await load();
      }catch(e){
        alert("Kunde inte uppdatera status: " + e.message);
      }
    }

    // ----- dashboard events -----
    document.addEventListener("click", (e) => {
      if (e.target.id === "reloadBtn") load();
      if (e.target.id === "newBtn")    $("#modal").classList.remove("hidden");
      if (e.target.id === "m_close")   $("#modal").classList.add("hidden");
    });

    searchInput?.addEventListener("input", render);

    for (const id of [ "tabAll","tabPending","tabConfirmed","tabCancelled" ]){
      document.getElementById(id)?.addEventListener("click", (ev) => {
        statusFilter = ev.currentTarget.dataset.status || "";
        load();
      });
    }

    // modal save
    $("#m_save").addEventListener("click", async () => {
      try{
        const payload = {
          name: $("#m_name").value.trim(),
          email: $("#m_email").value.trim(),
          phone: $("#m_phone").value.trim(),
          date: $("#m_date").value.trim(),
          time: $("#m_time").value.trim(),
          treatment: $("#m_treatment").value.trim()
        };
        if (!payload.email){ alert("E-post krävs."); return; }
        await api(`/portal/api/bookings/new`, {
          method:"POST",
          body: JSON.stringify(payload)
        });
        $("#modal").classList.add("hidden");
        for (const id of ["m_name","m_email","m_phone","m_date","m_time","m_treatment"]){ document.getElementById(id).value=""; }
        await load();
      }catch(e){
        alert("Kunde inte skapa bokning: " + e.message);
      }
    });

    // expose for inline buttons
    window.resend = resend;
    window.setStatus = setStatus;
  </script>
</body>
</html>