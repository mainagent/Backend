<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bookings Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config (rounded, shadowy, glassy)
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { 500: '#fb6a2a', 600: '#f04d18' },
            ink: { 50:'#f8fafc', 200:'#e2e8f0', 400:'#94a3b8', 600:'#475569', 800:'#0f172a' },
          },
          boxShadow: {
            glass: '0 1px 0 rgba(255,255,255,.06) inset, 0 10px 25px rgba(0,0,0,.25)',
          },
          backdropBlur: { xs: '2px' }
        }
      }
    }
  </script>
  <style>
    /* glass card */
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    .dark .glass {
      background: linear-gradient(180deg, rgba(17,24,39,.7), rgba(17,24,39,.45));
      border-color: rgba(148,163,184,.12);
    }
  </style>
</head>
<body class="h-full bg-gradient-to-br from-[#2a0000] via-[#1b1b1b] to-[#0b0b0b] text-ink-800 dark:text-ink-200">
  <!-- container -->
  <div class="min-h-full px-4 sm:px-6 lg:px-8 py-8">
    <!-- top bar -->
    <div class="max-w-6xl mx-auto">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-full bg-brand-600 flex items-center justify-center text-white font-semibold shadow-lg">TK</div>
          <div>
            <h1 class="text-2xl font-semibold tracking-tight text-white">Bookings</h1>
            <p class="text-sm text-ink-400">Admin panel</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <!-- Theme toggle -->
          <button id="themeToggle" class="glass rounded-lg px-3 py-2 text-sm text-white/90 hover:text-white">
            <span id="themeLabel">Dark</span> / Light
          </button>
          <a href="https://railway.app" target="_blank" class="hidden sm:inline glass rounded-lg px-3 py-2 text-sm text-white/90 hover:text-white">Railway</a>
        </div>
      </div>

      <!-- controls -->
      <div class="glass rounded-2xl p-4 sm:p-5 mb-6">
        <div class="grid sm:grid-cols-12 gap-3 items-center">
          <div class="sm:col-span-4">
            <label class="block text-xs uppercase tracking-wider text-ink-400 mb-1">X-Portal-Key</label>
            <input id="keyInput" type="password" class="w-full rounded-lg bg-black/30 border border-white/10 px-3 py-2 text-white placeholder:text-ink-400 focus:outline-none focus:ring-2 focus:ring-brand-600" placeholder="paste your portal key" />
          </div>
          <div class="sm:col-span-3">
            <label class="block text-xs uppercase tracking-wider text-ink-400 mb-1">Clinic</label>
            <input id="clinicInput" type="text" class="w-full rounded-lg bg-black/30 border border-white/10 px-3 py-2 text-white placeholder:text-ink-400 focus:outline-none focus:ring-2 focus:ring-brand-600" placeholder="default or mathias" />
          </div>
          <div class="sm:col-span-3">
            <label class="block text-xs uppercase tracking-wider text-ink-400 mb-1">Search</label>
            <input id="searchInput" type="text" class="w-full rounded-lg bg-black/30 border border-white/10 px-3 py-2 text-white placeholder:text-ink-400 focus:outline-none focus:ring-2 focus:ring-brand-600" placeholder="name, email, phone, code" />
          </div>
          <div class="sm:col-span-2 flex gap-2 pt-5 sm:pt-0">
            <button id="reloadBtn" class="flex-1 rounded-lg bg-brand-600 hover:bg-brand-500 text-white px-3 py-2 shadow-glass">Reload</button>
            <button id="newBtn" class="flex-1 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 shadow-glass">New</button>
          </div>
        </div>

        <!-- tabs + view -->
        <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2" id="tabs">
            <!-- built by JS -->
          </div>
          <div class="flex items-center gap-2">
            <button id="listBtn" class="rounded-lg px-3 py-1.5 text-sm bg-black/30 border border-white/10 text-white/80">List</button>
            <button id="gridBtn" class="rounded-lg px-3 py-1.5 text-sm bg-black/30 border border-white/10 text-white/80">Grid</button>
          </div>
        </div>
      </div>

      <!-- results -->
      <div id="results" class="max-w-6xl mx-auto"></div>
    </div>
  </div>

  <!-- NEW booking modal -->
  <dialog id="newModal" class="rounded-2xl p-0 w-[min(560px,95vw)] backdrop:bg-black/70">
    <form method="dialog" class="glass rounded-2xl p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-white">New booking</h3>
        <button class="text-ink-400 hover:text-white">&times;</button>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input id="nb_name"   class="rounded-lg bg-black/30 border border-white/10 px-3 py-2 text-white" placeholder="Name *" required />
        <input id="nb_email"  class="rounded-lg bg-black/30 border border-white/10 px-3 py-2 text-white" placeholder="Email *" required />
        <input id="nb_phone"  class="rounded-lg bg-black/30 border border-white/10 px-3 py-2 text-white" placeholder="Phone" />
        <input id="nb_treat"  class="rounded-lg bg-black/30 border border-white/10 px-3 py-2 text-white" placeholder="Treatment" />
        <input id="nb_date"   class="rounded-lg bg-black/30 border border-white/10 px-3 py-2 text-white" placeholder="YYYY-MM-DD *" required />
        <input id="nb_time"   class="rounded-lg bg-black/30 border border-white/10 px-3 py-2 text-white" placeholder="HH:MM *" required />
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button type="button" id="nb_submit" class="rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2">Create</button>
        <button class="rounded-lg bg-black/30 border border-white/10 text-white px-4 py-2">Close</button>
      </div>
      <p id="nb_msg" class="mt-3 text-sm text-ink-300"></p>
    </form>
  </dialog>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden rounded-xl bg-black/80 text-white px-4 py-2 text-sm shadow-xl"></div>

  <script>
    // ---------- Theme ----------
    const root = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel  = document.getElementById('themeLabel');
    const stored = localStorage.getItem('theme') || 'dark';
    if (stored === 'dark') document.documentElement.classList.add('dark');
    themeLabel.textContent = document.documentElement.classList.contains('dark') ? 'Dark' : 'Light';
    themeToggle.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      const mode = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      localStorage.setItem('theme', mode);
      themeLabel.textContent = mode === 'dark' ? 'Dark' : 'Light';
    });

    // ---------- State ----------
    const keyInput    = document.getElementById('keyInput');
    const clinicInput = document.getElementById('clinicInput');
    const searchInput = document.getElementById('searchInput');
    const reloadBtn   = document.getElementById('reloadBtn');
    const newBtn      = document.getElementById('newBtn');
    const listBtn     = document.getElementById('listBtn');
    const gridBtn     = document.getElementById('gridBtn');
    const results     = document.getElementById('results');
    const toast       = document.getElementById('toast');
    const tabsEl      = document.getElementById('tabs');
    const newModal    = document.getElementById('newModal');

    const API_BASE = `${location.origin}/portal/api`;
    let viewMode = localStorage.getItem('viewMode') || 'grid'; // 'grid' | 'list'
    let tab = localStorage.getItem('tab') || 'all'; // 'all'|'pending'|'confirmed'|'cancelled'
    let data = [];

    // Build tabs
    const TAB_DEF = [
      {id:'all', label:'All'},
      {id:'pending', label:'Pending'},
      {id:'confirmed', label:'Confirmed'},
      {id:'cancelled', label:'Cancelled'},
    ];
    function renderTabs(){
      tabsEl.innerHTML = '';
      TAB_DEF.forEach(t => {
        const b = document.createElement('button');
        b.className = `px-3 py-1.5 rounded-lg text-sm border ${tab===t.id?'bg-white/10 text-white border-white/20':'bg-black/30 text-white/70 border-white/10 hover:text-white'}`;
        b.textContent = t.label;
        b.addEventListener('click', ()=>{ tab = t.id; localStorage.setItem('tab', tab); loadBookings(); });
        tabsEl.appendChild(b);
      });
    }
    renderTabs();

    // UI helpers
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(()=>toast.classList.add('hidden'), 2000);
    }
    function pad4(id){ return String(id).padStart(4,'0'); }
    function codeFor(b){ return b.appointment_id || pad4(b.id); }
    function pill(status){
      const classes = {
        pending: 'bg-amber-500/15 text-amber-400 border-amber-400/20',
        confirmed: 'bg-emerald-500/15 text-emerald-400 border-emerald-400/20',
        cancelled: 'bg-rose-500/15 text-rose-400 border-rose-400/20',
      };
      return `<span class="px-2 py-0.5 rounded-full text-xs border ${classes[status]||'bg-slate-500/15 text-slate-300 border-slate-300/20'}">${status||'—'}</span>`;
    }

    // Renderers
    function render(){
      const q = (searchInput.value || '').toLowerCase();
      const filtered = data.filter(b => {
        const matchesStatus = (tab==='all') ? true : (b.status===tab);
        const hay = `${b.name||''}|${b.email||''}|${b.phone||''}|${codeFor(b)}`.toLowerCase();
        const matchesSearch = !q || hay.includes(q);
        return matchesStatus && matchesSearch;
      });

      // View toggle UI state
      listBtn.classList.toggle('ring-2', viewMode==='list');
      gridBtn.classList.toggle('ring-2', viewMode==='grid');

      if (viewMode==='list') {
        // table
        results.innerHTML = `
          <div class="glass rounded-2xl overflow-hidden">
            <table class="min-w-full text-sm text-ink-200">
              <thead class="bg-black/30 text-ink-300">
                <tr>
                  <th class="px-4 py-3 text-left">ID</th>
                  <th class="px-4 py-3 text-left">Code</th>
                  <th class="px-4 py-3 text-left">Name</th>
                  <th class="px-4 py-3 text-left">Email</th>
                  <th class="px-4 py-3 text-left">Phone</th>
                  <th class="px-4 py-3 text-left">Date</th>
                  <th class="px-4 py-3 text-left">Time</th>
                  <th class="px-4 py-3 text-left">Treatment</th>
                  <th class="px-4 py-3 text-left">Status</th>
                  <th class="px-4 py-3 text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody" class="divide-y divide-white/10"></tbody>
            </table>
          </div>`;
        const tb = results.querySelector('#tbody');
        tb.innerHTML = filtered.map(b => `
          <tr class="hover:bg-white/5">
            <td class="px-4 py-3 text-ink-400">${b.id}</td>
            <td class="px-4 py-3 font-mono">${codeFor(b)}</td>
            <td class="px-4 py-3">${b.name||'—'}</td>
            <td class="px-4 py-3">${b.email||'—'}</td>
            <td class="px-4 py-3">${b.phone||'—'}</td>
            <td class="px-4 py-3">${b.date||'—'}</td>
            <td class="px-4 py-3">${b.time||'—'}</td>
            <td class="px-4 py-3">${b.treatment||'—'}</td>
            <td class="px-4 py-3">${pill(b.status)}</td>
            <td class="px-4 py-3">
              <div class="flex justify-end gap-2">
                <button class="px-2 py-1 rounded border border-white/10 text-ink-200 hover:text-white" onclick="resend(${b.id})">Resend</button>
                <button class="px-2 py-1 rounded border border-emerald-400/20 text-emerald-300 hover:text-emerald-200" onclick="setStatus(${b.id},'confirmed')">Confirm</button>
                <button class="px-2 py-1 rounded border border-rose-400/20 text-rose-300 hover:text-rose-200" onclick="setStatus(${b.id},'cancelled')">Cancel</button>
              </div>
            </td>
          </tr>
        `).join('');
      } else {
        // grid of cards
        results.innerHTML = `
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            ${filtered.map(b => `
              <div class="glass rounded-2xl p-4 text-ink-200">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-ink-400">#${b.id}</div>
                  ${pill(b.status)}
                </div>
                <div class="mt-1 text-lg font-semibold">${b.name||'—'}</div>
                <div class="mt-1 text-sm text-ink-400">${b.email||'—'} · ${b.phone||'—'}</div>
                <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                  <div class="rounded-lg bg-black/30 border border-white/10 px-3 py-2">
                    <div class="text-ink-400 text-xs">Date</div>
                    <div>${b.date||'—'}</div>
                  </div>
                  <div class="rounded-lg bg-black/30 border border-white/10 px-3 py-2">
                    <div class="text-ink-400 text-xs">Time</div>
                    <div>${b.time||'—'}</div>
                  </div>
                </div>
                <div class="mt-2 text-sm"><span class="text-ink-400">Treatment:</span> ${b.treatment||'—'}</div>
                <div class="mt-2 text-sm"><span class="text-ink-400">Code:</span> <span class="font-mono">${codeFor(b)}</span></div>
                <div class="mt-3 flex gap-2">
                  <button class="flex-1 rounded-lg border border-white/10 px-3 py-2 text-ink-200 hover:text-white" onclick="resend(${b.id})">Resend</button>
                  <button class="rounded-lg border border-emerald-400/20 px-3 py-2 text-emerald-300 hover:text-emerald-200" onclick="setStatus(${b.id},'confirmed')">Confirm</button>
                  <button class="rounded-lg border border-rose-400/20 px-3 py-2 text-rose-300 hover:text-rose-200" onclick="setStatus(${b.id},'cancelled')">Cancel</button>
                </div>
              </div>
            `).join('')}
          </div>`;
      }
    }

    // Actions
    async function loadBookings(){
      const clinic = (clinicInput.value || 'default').trim();
      const key    = (keyInput.value || '').trim();
      const qs = new URLSearchParams({ clinic });
      if (tab !== 'all') qs.set('status', tab);
      const res = await fetch(`${API_BASE}/bookings?${qs}`, {
        headers: { 'X-Portal-Key': key }
      });
      if (!res.ok){ showToast(`Load failed: ${res.status}`); return; }
      const json = await res.json();
      data = json.items || [];
      render();
    }

    async function resend(id){
      const key = (keyInput.value || '').trim();
      const res = await fetch(`${API_BASE}/bookings/${id}/resend`, {
        method: 'POST',
        headers: { 'X-Portal-Key': key, 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      showToast(res.ok ? 'Resent confirmation' : `Resend failed: ${res.status}`);
    }

    async function setStatus(id,status){
      const key = (keyInput.value || '').trim();
      const res = await fetch(`${API_BASE}/bookings/${id}/status`, {
        method: 'POST',
        headers: { 'X-Portal-Key': key, 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      if (res.ok){ showToast('Updated'); loadBookings(); }
      else showToast(`Update failed: ${res.status}`);
    }

    // New booking
    document.getElementById('nb_submit').addEventListener('click', async () => {
      const key = (keyInput.value || '').trim();
      const clinic = (clinicInput.value || 'default').trim();
      const payload = {
        name:  document.getElementById('nb_name').value.trim(),
        email: document.getElementById('nb_email').value.trim(),
        phone: document.getElementById('nb_phone').value.trim(),
        treatment: document.getElementById('nb_treat').value.trim(),
        date:  document.getElementById('nb_date').value.trim(),
        time:  document.getElementById('nb_time').value.trim(),
      };
      const res = await fetch(`${API_BASE}/bookings/new?clinic=${encodeURIComponent(clinic)}`, {
        method: 'POST',
        headers: { 'X-Portal-Key': key, 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const msg = document.getElementById('nb_msg');
      if (res.ok){ msg.textContent = 'Created ✓'; loadBookings(); setTimeout(()=>newModal.close(), 600); }
      else { msg.textContent = `Failed: ${res.status}`; }
    });

    // Wire controls
    reloadBtn.addEventListener('click', loadBookings);
    newBtn   .addEventListener('click', () => newModal.showModal());
    listBtn  .addEventListener('click', ()=>{ viewMode='list'; localStorage.setItem('viewMode','list'); render(); });
    gridBtn  .addEventListener('click', ()=>{ viewMode='grid'; localStorage.setItem('viewMode','grid'); render(); });
    searchInput.addEventListener('input', render);

    // Boot
    // Try to prefill clinic from ?clinic=
    const urlClinic = new URLSearchParams(location.search).get('clinic');
    if (urlClinic) clinicInput.value = urlClinic;
    render();
  </script>
</body>
</html>