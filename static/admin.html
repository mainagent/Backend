<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bookings Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class'}</script>
</head>
<body class="min-h-full bg-white text-neutral-900 dark:bg-neutral-950 dark:text-neutral-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Top bar -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Bookings</h1>
        <p class="text-sm text-neutral-500 dark:text-neutral-400">Admin panel</p>
      </div>
      <button id="themeToggle"
              class="rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm text-neutral-900 shadow-sm
                     hover:bg-neutral-50 dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-200 dark:hover:bg-neutral-800">
        <span id="themeLabel">Dark</span> / Light
      </button>
    </div>

    <!-- Controls -->
    <div class="rounded-2xl border border-neutral-200 bg-white p-4 sm:p-5 shadow-sm
                dark:border-neutral-800 dark:bg-neutral-900 mb-6">
      <div class="grid sm:grid-cols-12 gap-3">
        <div class="sm:col-span-4">
          <label class="block text-xs font-medium text-neutral-500 dark:text-neutral-400 mb-1">X-Portal-Key</label>
          <input id="keyInput" type="password"
            class="w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 shadow-sm
                   focus:outline-none focus:ring-2 focus:ring-neutral-900/20
                   dark:border-neutral-700 dark:bg-neutral-900 dark:focus:ring-white/20"
            placeholder="paste your portal key" />
        </div>
        <div class="sm:col-span-3">
          <label class="block text-xs font-medium text-neutral-500 dark:text-neutral-400 mb-1">Clinic</label>
          <input id="clinicInput" type="text"
            class="w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 shadow-sm
                   focus:outline-none focus:ring-2 focus:ring-neutral-900/20
                   dark:border-neutral-700 dark:bg-neutral-900 dark:focus:ring-white/20"
            placeholder="default or mathias" />
        </div>
        <div class="sm:col-span-3">
          <label class="block text-xs font-medium text-neutral-500 dark:text-neutral-400 mb-1">Search</label>
          <input id="searchInput" type="text"
            class="w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 shadow-sm
                   focus:outline-none focus:ring-2 focus:ring-neutral-900/20
                   dark:border-neutral-700 dark:bg-neutral-900 dark:focus:ring-white/20"
            placeholder="name, email, phone, code" />
        </div>
        <div class="sm:col-span-2 flex gap-2 pt-5 sm:pt-0">
          <!-- Primary (neutral) -->
          <button id="reloadBtn"
            class="flex-1 rounded-lg bg-neutral-900 text-white px-3 py-2 shadow-sm hover:bg-black
                   dark:bg-white dark:text-neutral-900 dark:hover:bg-neutral-200">Reload</button>
          <button id="newBtn"
            class="flex-1 rounded-lg border border-neutral-300 px-3 py-2 shadow-sm hover:bg-neutral-50
                   dark:border-neutral-700 dark:hover:bg-neutral-800">New</button>
        </div>
      </div>

      <!-- tabs + view -->
      <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-2" id="tabs"></div>
        <div class="flex items-center gap-2">
          <button id="listBtn" class="rounded-lg px-3 py-1.5 text-sm border border-neutral-300 hover:bg-neutral-50
                                     dark:border-neutral-700 dark:hover:bg-neutral-800">List</button>
          <button id="gridBtn" class="rounded-lg px-3 py-1.5 text-sm border border-neutral-300 hover:bg-neutral-50
                                     dark:border-neutral-700 dark:hover:bg-neutral-800">Grid</button>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div id="results"></div>
  </div>

  <!-- New booking modal -->
  <dialog id="newModal" class="rounded-2xl p-0 w-[min(560px,95vw)] backdrop:bg-black/60">
    <form method="dialog"
      class="rounded-2xl border border-neutral-200 bg-white p-5 shadow-sm
             dark:border-neutral-800 dark:bg-neutral-900">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">New booking</h3>
        <button class="text-neutral-500 dark:text-neutral-400">&times;</button>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input id="nb_name"  class="rounded-lg border border-neutral-300 bg-white px-3 py-2 shadow-sm dark:border-neutral-700 dark:bg-neutral-900" placeholder="Name *" required />
        <input id="nb_email" class="rounded-lg border border-neutral-300 bg-white px-3 py-2 shadow-sm dark:border-neutral-700 dark:bg-neutral-900" placeholder="Email *" required />
        <input id="nb_phone" class="rounded-lg border border-neutral-300 bg-white px-3 py-2 shadow-sm dark:border-neutral-700 dark:bg-neutral-900" placeholder="Phone" />
        <input id="nb_treat" class="rounded-lg border border-neutral-300 bg-white px-3 py-2 shadow-sm dark:border-neutral-700 dark:bg-neutral-900" placeholder="Treatment" />
        <input id="nb_date"  class="rounded-lg border border-neutral-300 bg-white px-3 py-2 shadow-sm dark:border-neutral-700 dark:bg-neutral-900" placeholder="YYYY-MM-DD *" required />
        <input id="nb_time"  class="rounded-lg border border-neutral-300 bg-white px-3 py-2 shadow-sm dark:border-neutral-700 dark:bg-neutral-900" placeholder="HH:MM *" required />
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button type="button" id="nb_submit"
          class="rounded-lg bg-neutral-900 text-white px-4 py-2 shadow-sm hover:bg-black
                 dark:bg-white dark:text-neutral-900 dark:hover:bg-neutral-200">Create</button>
        <button class="rounded-lg border border-neutral-300 px-4 py-2 shadow-sm hover:bg-neutral-50
                       dark:border-neutral-700 dark:hover:bg-neutral-800">Close</button>
      </div>
      <p id="nb_msg" class="mt-3 text-sm text-neutral-500 dark:text-neutral-400"></p>
    </form>
  </dialog>

  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden rounded-xl bg-neutral-900 text-white px-4 py-2 text-sm shadow-lg
                        dark:bg-white dark:text-neutral-900"></div>

  <script>
    // Theme toggle (pure light/dark)
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel  = document.getElementById('themeLabel');
    const savedTheme  = localStorage.getItem('theme') || 'dark';
    if (savedTheme === 'dark') document.documentElement.classList.add('dark');
    themeLabel.textContent = document.documentElement.classList.contains('dark') ? 'Dark' : 'Light';
    themeToggle.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      const mode = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      localStorage.setItem('theme', mode);
      themeLabel.textContent = mode === 'dark' ? 'Dark' : 'Light';
    });

    // Elements & state
    const keyInput    = document.getElementById('keyInput');
    const clinicInput = document.getElementById('clinicInput');
    const searchInput = document.getElementById('searchInput');
    const reloadBtn   = document.getElementById('reloadBtn');
    const newBtn      = document.getElementById('newBtn');
    const listBtn     = document.getElementById('listBtn');
    const gridBtn     = document.getElementById('gridBtn');
    const results     = document.getElementById('results');
    const tabsEl      = document.getElementById('tabs');
    const newModal    = document.getElementById('newModal');
    const toast       = document.getElementById('toast');
    const API_BASE    = `${location.origin}/portal/api`;

    let viewMode = localStorage.getItem('viewMode') || 'grid';
    let tab = localStorage.getItem('tab') || 'all';
    let data = [];

    // Tabs
    const TABS = [
      {id:'all', label:'All'},
      {id:'pending', label:'Pending'},
      {id:'confirmed', label:'Confirmed'},
      {id:'cancelled', label:'Cancelled'},
    ];
    function renderTabs(){
      tabsEl.innerHTML = '';
      TABS.forEach(t=>{
        const b=document.createElement('button');
        b.textContent=t.label;
        b.className=`px-3 py-1.5 rounded-lg text-sm border ${
          tab===t.id?'border-neutral-900 bg-neutral-900 text-white dark:border-white dark:bg-white dark:text-neutral-900':
                     'border-neutral-300 hover:bg-neutral-50 dark:border-neutral-700 dark:hover:bg-neutral-800'}`;
        b.onclick=()=>{tab=t.id;localStorage.setItem('tab',tab);loadBookings();};
        tabsEl.appendChild(b);
      });
    }
    renderTabs();

    // Helpers
    function showToast(msg){
      toast.textContent=msg;
      toast.classList.remove('hidden');
      setTimeout(()=>toast.classList.add('hidden'),1800);
    }
    const pad4 = id => String(id).padStart(4,'0');
    const codeFor = b => b.appointment_id || pad4(b.id);
    const pill = s => {
      const map = {
        pending  : 'bg-amber-100 text-amber-800 border-amber-200 dark:bg-amber-900/30 dark:text-amber-300 dark:border-amber-800',
        confirmed: 'bg-emerald-100 text-emerald-800 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-300 dark:border-emerald-800',
        cancelled: 'bg-rose-100 text-rose-800 border-rose-200 dark:bg-rose-900/30 dark:text-rose-300 dark:border-rose-800',
      };
      return `<span class="px-2 py-0.5 rounded-full text-xs border ${map[s]||'bg-neutral-100 text-neutral-700 border-neutral-200 dark:bg-neutral-800/40 dark:text-neutral-300 dark:border-neutral-700'}">${s||'—'}</span>`;
    };

    // Render
    function render(){
      const q=(searchInput.value||'').toLowerCase();
      const list=(tab==='all')?data:data.filter(b=>b.status===tab);
      const filtered=list.filter(b=>{
        const hay=`${b.name||''}|${b.email||''}|${b.phone||''}|${codeFor(b)}`.toLowerCase();
        return !q || hay.includes(q);
      });

      // view buttons state
      [listBtn,gridBtn].forEach(b=>b.classList.remove('ring','ring-neutral-300','dark:ring-neutral-700'));
      (viewMode==='list'?listBtn:gridBtn).classList.add('ring','ring-neutral-300','dark:ring-neutral-700');

      if(viewMode==='list'){
        results.innerHTML = `
          <div class="rounded-2xl border border-neutral-200 bg-white shadow-sm dark:border-neutral-800 dark:bg-neutral-900 overflow-hidden">
            <table class="min-w-full text-sm">
              <thead class="bg-neutral-50 text-neutral-600 dark:bg-neutral-900/60 dark:text-neutral-300">
                <tr>
                  <th class="px-4 py-3 text-left">ID</th>
                  <th class="px-4 py-3 text-left">Code</th>
                  <th class="px-4 py-3 text-left">Name</th>
                  <th class="px-4 py-3 text-left">Email</th>
                  <th class="px-4 py-3 text-left">Phone</th>
                  <th class="px-4 py-3 text-left">Date</th>
                  <th class="px-4 py-3 text-left">Time</th>
                  <th class="px-4 py-3 text-left">Treatment</th>
                  <th class="px-4 py-3 text-left">Status</th>
                  <th class="px-4 py-3 text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody" class="divide-y divide-neutral-200 dark:divide-neutral-800"></tbody>
            </table>
          </div>`;
        const tb=results.querySelector('#tbody');
        tb.innerHTML = filtered.map(b=>`
          <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-800/40">
            <td class="px-4 py-3 text-neutral-500 dark:text-neutral-400">${b.id}</td>
            <td class="px-4 py-3 font-mono">${codeFor(b)}</td>
            <td class="px-4 py-3">${b.name||'—'}</td>
            <td class="px-4 py-3">${b.email||'—'}</td>
            <td class="px-4 py-3">${b.phone||'—'}</td>
            <td class="px-4 py-3">${b.date||'—'}</td>
            <td class="px-4 py-3">${b.time||'—'}</td>
            <td class="px-4 py-3">${b.treatment||'—'}</td>
            <td class="px-4 py-3">${pill(b.status)}</td>
            <td class="px-4 py-3">
              <div class="flex justify-end gap-2">
                <button class="px-2 py-1 rounded border border-neutral-300 hover:bg-neutral-50
                               dark:border-neutral-700 dark:hover:bg-neutral-800" onclick="resend(${b.id})">Resend</button>
                <button class="px-2 py-1 rounded border border-neutral-300 hover:bg-neutral-50
                               dark:border-neutral-700 dark:hover:bg-neutral-800" onclick="setStatus(${b.id},'confirmed')">Confirm</button>
                <button class="px-2 py-1 rounded border border-neutral-300 hover:bg-neutral-50
                               dark:border-neutral-700 dark:hover:bg-neutral-800" onclick="setStatus(${b.id},'cancelled')">Cancel</button>
              </div>
            </td>
          </tr>`).join('');
      } else {
        results.innerHTML = `
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            ${filtered.map(b=>`
              <div class="rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm
                          dark:border-neutral-800 dark:bg-neutral-900">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-neutral-500 dark:text-neutral-400">#${b.id}</div>
                  ${pill(b.status)}
                </div>
                <div class="mt-1 text-lg font-semibold">${b.name||'—'}</div>
                <div class="mt-1 text-sm text-neutral-500 dark:text-neutral-400">${b.email||'—'} · ${b.phone||'—'}</div>
                <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                  <div class="rounded-lg border border-neutral-200 bg-white px-3 py-2 dark:border-neutral-800 dark:bg-neutral-900">
                    <div class="text-xs text-neutral-500 dark:text-neutral-400">Date</div>
                    <div>${b.date||'—'}</div>
                  </div>
                  <div class="rounded-lg border border-neutral-200 bg-white px-3 py-2 dark:border-neutral-800 dark:bg-neutral-900">
                    <div class="text-xs text-neutral-500 dark:text-neutral-400">Time</div>
                    <div>${b.time||'—'}</div>
                  </div>
                </div>
                <div class="mt-2 text-sm"><span class="text-neutral-500 dark:text-neutral-400">Treatment:</span> ${b.treatment||'—'}</div>
                <div class="mt-2 text-sm"><span class="text-neutral-500 dark:text-neutral-400">Code:</span> <span class="font-mono">${codeFor(b)}</span></div>
                <div class="mt-3 flex gap-2">
                  <button class="flex-1 rounded-lg border border-neutral-300 px-3 py-2 hover:bg-neutral-50
                                 dark:border-neutral-700 dark:hover:bg-neutral-800" onclick="resend(${b.id})">Resend</button>
                  <button class="rounded-lg border border-neutral-300 px-3 py-2 hover:bg-neutral-50
                                 dark:border-neutral-700 dark:hover:bg-neutral-800" onclick="setStatus(${b.id},'confirmed')">Confirm</button>
                  <button class="rounded-lg border border-neutral-300 px-3 py-2 hover:bg-neutral-50
                                 dark:border-neutral-700 dark:hover:bg-neutral-800" onclick="setStatus(${b.id},'cancelled')">Cancel</button>
                </div>
              </div>
            `).join('')}
          </div>`;
      }
    }

    // API actions
    async function loadBookings(){
      const clinic=(clinicInput.value||'default').trim();
      const key=(keyInput.value||'').trim();
      const qs=new URLSearchParams({clinic});
      if(tab!=='all') qs.set('status',tab);
      const res=await fetch(`${API_BASE}/bookings?${qs}`,{headers:{'X-Portal-Key':key}});
      if(!res.ok){showToast(`Load failed: ${res.status}`);return;}
      const json=await res.json();
      data=json.items||[];
      render();
    }
    async function resend(id){
      const key=(keyInput.value||'').trim();
      const res=await fetch(`${API_BASE}/bookings/${id}/resend`,{
        method:'POST',
        headers:{'X-Portal-Key':key,'Content-Type':'application/json'},
        body:JSON.stringify({})
      });
      showToast(res.ok?'Resent confirmation':`Resend failed: ${res.status}`);
    }
    async function setStatus(id,status){
      const key=(keyInput.value||'').trim();
      const res=await fetch(`${API_BASE}/bookings/${id}/status`,{
        method:'POST',
        headers:{'X-Portal-Key':key,'Content-Type':'application/json'},
        body:JSON.stringify({status})
      });
      if(res.ok){showToast('Updated');loadBookings();}
      else showToast(`Update failed: ${res.status}`);
    }

    // New booking
    document.getElementById('nb_submit').addEventListener('click', async ()=>{
      const key=(keyInput.value||'').trim();
      const clinic=(clinicInput.value||'default').trim();
      const payload={
        name:document.getElementById('nb_name').value.trim(),
        email:document.getElementById('nb_email').value.trim(),
        phone:document.getElementById('nb_phone').value.trim(),
        treatment:document.getElementById('nb_treat').value.trim(),
        date:document.getElementById('nb_date').value.trim(),
        time:document.getElementById('nb_time').value.trim(),
      };
      const res=await fetch(`${API_BASE}/bookings/new?clinic=${encodeURIComponent(clinic)}`,{
        method:'POST',
        headers:{'X-Portal-Key':key,'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const msg=document.getElementById('nb_msg');
      if(res.ok){msg.textContent='Created ✓';loadBookings();setTimeout(()=>newModal.close(),600);}
      else msg.textContent=`Failed: ${res.status}`;
    });

    // Wire UI
    document.getElementById('reloadBtn').addEventListener('click', loadBookings);
    document.getElementById('newBtn').addEventListener('click', ()=>newModal.showModal());
    document.getElementById('listBtn').addEventListener('click', ()=>{viewMode='list';localStorage.setItem('viewMode','list');render();});
    document.getElementById('gridBtn').addEventListener('click', ()=>{viewMode='grid';localStorage.setItem('viewMode','grid');render();});
    document.getElementById('searchInput').addEventListener('input', render);

    // Boot
    const urlClinic=new URLSearchParams(location.search).get('clinic');
    if(urlClinic) clinicInput.value=urlClinic;
    render();
  </script>
</body>
</html>